@page
@model ECommerce.Pages.CheckoutModel
@{
    ViewData["Title"] = "Checkout";
}

<div class="container-fluid bg-secondary mb-5">
  <div class="d-flex flex-column align-items-center justify-content-center" style="min-height:300px">
    <h1 class="font-weight-semi-bold text-uppercase mb-3">Checkout</h1>
  </div>
</div>

<form id="checkoutForm" method="post">
  <div class="container-fluid pt-5">
    <div class="row px-xl-5">
      <!-- Billing Address -->
      <div class="col-lg-8">
        <div class="mb-4">
          <h4 class="font-weight-semi-bold mb-4">Adresse de facturation</h4>
          <div class="row">
            <div class="col-md-6 form-group">
              <label asp-for="FullName">Nom complet</label>
              <input asp-for="FullName" class="form-control" />
              <span asp-validation-for="FullName" class="text-danger"></span>
            </div>
            <div class="col-md-6 form-group">
              <label asp-for="Email">E-mail</label>
              <input asp-for="Email" class="form-control" readonly />
            </div>
            <div class="col-md-6 form-group">
              <label asp-for="Phone">Téléphone</label>
              <input asp-for="Phone" class="form-control" />
              <span asp-validation-for="Phone" class="text-danger"></span>
            </div>
            <div class="col-md-6 form-group">
              <label asp-for="Address">Adresse</label>
              <input asp-for="Address" class="form-control" />
              <span asp-validation-for="Address" class="text-danger"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary + PayPal -->
      <div class="col-lg-4">
        <div class="card border-secondary mb-5">
          <div class="card-header bg-secondary border-0">
            <h4 class="font-weight-semi-bold m-0">Résumé de la commande</h4>
          </div>
          <div class="card-body">
            <h5 class="font-weight-medium mb-3">Détails des produits</h5>
            <table class="table">
              <thead>
                <tr><th>Produit</th><th>Quantité</th><th>Total</th></tr>
              </thead>
              <tbody>
                @foreach (var item in Model.CartProducts)
                {
                  <tr>
                    <td>@item.ProductName</td>
                    <td>@item.Quantity</td>
                    <td>@(item.Product.Price * item.Quantity) $</td>
                  </tr>
                }
              </tbody>
            </table>
            <hr class="mt-0" />
            <div class="d-flex justify-content-between mb-3 pt-1">
              <h6 class="font-weight-medium">Sous-total</h6>
              <h6 class="font-weight-medium">@Model.TotalAmount $</h6>
            </div>
            <div class="d-flex justify-content-between">
              <h6 class="font-weight-medium">Frais de livraison</h6>
              <h6 class="font-weight-medium">$10</h6>
            </div>
          </div>
          <div class="card-footer border-secondary bg-transparent">
            <div class="d-flex justify-content-between mt-2">
              <h5 class="font-weight-bold">Total</h5>
              <h5 class="font-weight-bold">@(Model.TotalAmount + 10) $</h5>
            </div>
          </div>
        </div>

        <!-- Bouton PayPal -->
        <div id="paypal-button-container"></div>
      </div>
    </div>
  </div>
</form>

@section Scripts {
  <script src="https://www.paypal.com/sdk/js?client-id=TON_CLIENT_ID&currency=USD"></script>
  <script>
    paypal.Buttons({
      createOrder: (data, actions) => {
        const total = parseFloat('@(Model.TotalAmount + 10)');
        return actions.order.create({
          purchase_units: [{ amount: { value: total.toFixed(2) } }]
        });
      },
      onApprove: (data, actions) => actions.order.capture().then(details => {
        const payload = {
          orderID:  data.orderID,
          payerID:  data.payerID,
          fullName: document.getElementById('FullName').value,
          address:  document.getElementById('Address').value,
          phone:    document.getElementById('Phone').value
        };
        fetch('@Url.Page("Checkout")?handler=PayPal', {
          method: 'POST',
          headers: {
            'Content-Type':              'application/json',
            'RequestVerificationToken':  document.querySelector('input[name="__RequestVerificationToken"]').value
          },
          body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
          if (res.success) window.location.href = res.redirectUrl;
          else              alert('Erreur lors de la création de la commande.');
        });
      })
    }).render('#paypal-button-container');
  </script>
}

